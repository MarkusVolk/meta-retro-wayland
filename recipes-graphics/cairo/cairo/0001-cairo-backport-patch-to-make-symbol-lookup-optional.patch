From 623e718303202f92180fcfac47c38f1989c256b8 Mon Sep 17 00:00:00 2001
From: Markus Volk <f_l_k@t-online.de>
Date: Sun, 13 Mar 2022 19:16:29 +0100
Subject: [PATCH] cairo: backport patch to make symbol-lookup optional

Upstream-Status: Backport

Signed-off-by: Markus Volk <f_l_k@t-online.de>
---
 meson.build       | 16 ++++++++--------
 meson_options.txt |  4 ++++
 2 files changed, 12 insertions(+), 8 deletions(-)

diff --git a/meson.build b/meson.build
index b159b4071..fbd9e670b 100644
--- a/meson.build
+++ b/meson.build
@@ -657,14 +657,14 @@ if zlib_dep.found() and png_dep.found()
   }]
 endif
 
-# Untested, libiberty.h is in a libiberty subfolder for me
-# FIXME: automagic
-bfd_dep = cc.find_library('bfd', required: false)
-if bfd_dep.found() and cc.has_function('bfd_openr', dependencies: [bfd_dep])
-  if cc.has_header('libiberty.h')
-    conf.set('HAVE_BFD', 1)
-    deps += [bfd_dep]
-  endif
+bfd_dep = cc.find_library('bfd', has_headers: ['bfd.h'], required: get_option('symbol-lookup'))
+if bfd_dep.found() and \
+   cc.has_function('bfd_openr', dependencies: [bfd_dep]) and \
+   cc.links(files('meson-cc-tests/bfd-section-flags.c'), name: 'bfd_section_flags', dependencies: bfd_dep)
+  conf.set('HAVE_BFD', 1)
+  deps += [bfd_dep]
+elif get_option('symbol-lookup').enabled()
+  error('symbol lookup via bfd was enabled via options but is not available (bfd might be too old)')
 endif
 
 # Untested, see above
diff --git a/meson_options.txt b/meson_options.txt
index ff11fe7ed..46e48b12e 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -23,6 +23,10 @@ option('zlib', type : 'feature', value : 'auto') # script, ps, pdf, xml surfaces
 # Tests
 option('tests', type : 'feature', value : 'auto')
 
+#Symbol lookup
+option('symbol-lookup', type: 'feature', value : 'auto',
+       description: 'Symbol lookup in debug utils via binutils/bfd')
+
 # Util deps
 option('gtk2-utils', type : 'feature', value : 'disabled')
 
-- 
2.25.1

